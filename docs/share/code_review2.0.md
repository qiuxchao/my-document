# Code Review 2.0

Code Review 1.0 ä¸­å­˜åœ¨çš„é—®é¢˜ï¼š

- åªåœ¨å°ç¨‹åºé¡¹ç›®ä¸­é…ç½®äº† `mr` è„šæœ¬ï¼Œä¸æ”¯æŒå…¶å®ƒé¡¹ç›®ï¼Œå¦‚è¦æ”¯æŒå…¶å®ƒé¡¹ç›®éœ€æ‹·è´ä»£ç ï¼Œæ‰©å±•æ€§å·®ï¼›
- è„šæœ¬ä¸­æ‰€æœ‰äººçš„ `GitLab Token` éƒ½æš´éœ²å‡ºæ¥ï¼Œå®‰å…¨æ€§å·®ï¼›
- æœåŠ¡ç«¯çš„æ•°æ®ï¼ˆç”¨æˆ·æ•°æ®ã€æœºå™¨äººåœ°å€æ•°æ®ï¼‰éƒ½éœ€è¦æ‰‹åŠ¨ä¿®æ”¹ä»£ç æ¥ç»´æŠ¤ã€‚

2.0 è§£å†³é—®é¢˜ï¼š

- å°†åŸæ¥çš„ `mr` è„šæœ¬ç¼–å†™æˆå‘½ä»¤è¡Œå·¥å…· `npm` åŒ…ï¼Œå®ç°ä¸€æ¬¡å®‰è£…å¤šå¤„ä½¿ç”¨ ğŸ‘ï¼›
- åªç”¨åœ¨å®‰è£… `mr` åŒ…æ—¶é…ç½®ä¸€æ¬¡ `GitLab Token`ï¼Œä¸”å­˜å‚¨åœ¨ç”¨æˆ·æœ¬åœ°ï¼Œä¾¿æ·æ€§ã€å®‰å…¨æ€§ ğŸ†™ï¼›
- æä¾›ä¸æœåŠ¡ç«¯äº¤äº’çš„å­å‘½ä»¤ï¼Œå¯ä»¥ç›´æ¥åœ¨å‰ç«¯ç»´æŠ¤æœåŠ¡ç«¯æ•°æ® ğŸ”¨ã€‚

![fx_mr_cli](./image/fx_mr_cli.png)

> [ğŸ”— mrå·¥å…·ä½¿ç”¨æ–‡æ¡£](https://qiuxc.cn/share/mr_cli.html)

## æ¥å…¥CRæµç¨‹

### é…ç½® GitLab Webhook

é…ç½®æŒ‡å®šé¡¹ç›®çš„ GitLab Webhook åï¼Œåç»­åœ¨è¯¥é¡¹ç›®ä¸­è¿›è¡Œçš„MRæˆ–è¯„è®ºæ“ä½œéƒ½å°†æ¨é€åˆ°é’‰é’‰ç¾¤ä¸­ã€‚

åœ¨ `GitLab` æŒ‡å®šçš„é¡¹ç›®ä¸‹é…ç½® `Webhook`ï¼Œå‹¾é€‰ã€Œè¯„è®ºäº‹ä»¶(Note Events)ã€å’Œã€Œåˆå¹¶è¯·æ±‚äº‹ä»¶(Merge Requests Events)ã€

<!-- ![join_up_mr](./image/join_up_mr.png) -->

### å®‰è£… fx-mr-cli å‘½ä»¤è¡Œå·¥å…·åŒ…

`fx-mr-cli` æ˜¯ä¸€ä¸ª GitLab Merge Request å‘½ä»¤è¡Œå·¥å…·ï¼Œèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬åœ¨å‘½ä»¤è¡Œä¸­äº¤äº’å¼åˆ›å»º Merge Reqeustã€‚

å…¨å±€å®‰è£… `fx-mr-cli` npmåŒ…ï¼Œå…·ä½“å®‰è£…åŠä½¿ç”¨å‚è€ƒï¼š[fx-mr-cli å‘½ä»¤è¡Œå·¥å…·ä½¿ç”¨æ•™ç¨‹](https://qiuxc.cn/share/mr_cli.html)

## å‰ç«¯å®ç°

- å€ŸåŠ© `yargs` åº“æ¥ç¼–å†™å‘½ä»¤è¡Œå·¥å…·

- å°†é¡¹ç›®ç¼–å†™æˆ `npm` åŒ…ï¼Œå‘å¸ƒåœ¨å…¬å¸ç§æœ‰ä»“åº“ä¸Š

### yargs å‘½ä»¤è¡Œè§£æåº“

`yargs` æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°è§£æåº“ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿæ„å»ºä¸€ä¸ªå‘½ä»¤è¡Œç¨‹åºã€‚ç±»ä¼¼åŠŸèƒ½çš„åº“è¿˜æœ‰ `commander`ã€`meow`ã€‚

> [ğŸ”— yargs å®˜æ–¹æ–‡æ¡£](http://yargs.js.org/docs/)

#### option é€‰é¡¹

é€šè¿‡ `option` æ–¹æ³•ï¼Œå¯ä»¥è‡ªå®šä¹‰é€‰é¡¹ï¼Œä¾‹å¦‚é»˜è®¤çš„æŸ¥çœ‹ç‰ˆæœ¬å·å’ŒæŸ¥çœ‹å¸®åŠ©èœå•ï¼š

```sh
mr -h
mr -v
```

> [ğŸ”— option ä½¿ç”¨æ–¹æ³•](http://yargs.js.org/docs/#api-reference-optionkey-opt)

#### command å­å‘½ä»¤

é€šè¿‡ `command` æ–¹æ³•ï¼Œå¯ä»¥è®¾ç½® `Git` é£æ ¼çš„å­å‘½ä»¤:

```sh
mr token
mr user
mr dtu
```

> [ğŸ”— command ä½¿ç”¨æ–¹æ³•](http://yargs.js.org/docs/#api-reference-commandcmd-desc-builder-handler)

### npm å‘åŒ…

`npm` è§„å®šéœ€è¦å°†å¯æ‰§è¡Œçš„å‘½ä»¤æ”¾åœ¨ `bin` ç›®å½•ä¸‹ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ç›®å½•ç»“æ„ä¸ºï¼š

```sh
.
â”œâ”€â”€ bin
â”‚   â”œâ”€â”€ mr
â”‚   â”œâ”€â”€ create.js
â”‚   â””â”€â”€ ...
â”œâ”€â”€ utils
â””â”€â”€ package.json
```

è¿˜éœ€åœ¨ `package.json` ç¨ä½œé…ç½®ï¼š

```json
{
  ...
  "bin": {
    "mr": "bin/mr"
  },
  "files": [
    "bin",
    "utils"
  ],
  "publishConfig": {
    "registry": "å…¬å¸ä»“åº“åœ°å€"
  },
  ...
}

```

è¿è¡Œ `npm publish` å³å¯å°†å½“å‰ `bin`ã€`utils` ä¸­çš„æ–‡ä»¶æ‰“åŒ…ä¸Šä¼ è‡³ `npm` ä»“åº“

## æœåŠ¡ç«¯å®ç°

æœåŠ¡ç«¯æŒ‰ç…§ `egg` çš„è§„èŒƒå¯¹ä»£ç è¿›è¡Œäº†é‡æ„ï¼Œä½¿å…¶ä¾¿äºç»´æŠ¤ã€‚

### egg åŸºç¡€åŠŸèƒ½

- `Router` è·¯ç”±ã€‚æš´éœ²ç»™å‰ç«¯çš„æ¥å£ï¼ŒæŒ‡å‘å¯¹åº”çš„ `Controller`
- `Controller` æ§åˆ¶å™¨ã€‚è§£æå‰ç«¯çš„è¯·æ±‚ï¼Œå¤„ç†åè¿”å›ç›¸åº”çš„ç»“æœ
- `Service` æœåŠ¡ã€‚ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œä¾› `Controller` è°ƒç”¨
- `Middleware` ä¸­é—´ä»¶ã€‚ç±»ä¼¼äºæ‹¦æˆªå™¨

### è¿œç¨‹æ•°æ®ç»´æŠ¤

- å°†æ•°æ®å­˜å‚¨åœ¨ `json` æ–‡ä»¶ä¸­

- æš´éœ²æ¥å£å‡ºå»ï¼Œç”¨äºå¯¹ `json` æ–‡ä»¶ä¸­çš„æ•°æ®è¿›è¡Œå¢åˆ æ”¹æŸ¥

### token æ ¡éªŒä¸­é—´ä»¶

å°†å‰ç«¯ä¼ è¿‡æ¥çš„ `token` ä¼ ç»™ `GitLab`ï¼ŒéªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œæ ‡è¯† `token` æ˜¯å¦æœ‰æ•ˆã€‚
