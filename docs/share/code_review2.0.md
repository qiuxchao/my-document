<!--
 * @Descripttion: 
 * @version: 
 * @Author: qiuxchao
 * @Date: 2022-08-18 15:45:21
 * @LastEditors: qiuxchao
 * @LastEditTime: 2022-09-05 09:37:29
-->
# Code Review 2.0

Code Review 1.0 ä¸­å­˜åœ¨çš„é—®é¢˜ï¼š
- åªåœ¨å°ç¨‹åºé¡¹ç›®ä¸­é…ç½®äº† `Node` è„šæœ¬ï¼Œä¸æ”¯æŒå…¶å®ƒé¡¹ç›®ï¼Œå¦‚è¦æ”¯æŒå…¶å®ƒé¡¹ç›®éœ€æ‹·è´ä»£ç ï¼Œæ‰©å±•æ€§å·®ï¼›
- è„šæœ¬ä¸­æ‰€æœ‰äººçš„ `GitLab Token` éƒ½æš´éœ²å‡ºæ¥ï¼Œå®‰å…¨æ€§å·®ï¼›
- æœåŠ¡ç«¯çš„æ•°æ®ï¼ˆç”¨æˆ·æ•°æ®ã€æœºå™¨äººåœ°å€æ•°æ®ï¼‰éƒ½éœ€è¦æ‰‹åŠ¨ä¿®æ”¹ä»£ç æ¥ç»´æŠ¤ã€‚

è§£å†³é—®é¢˜ï¼š
- å°†åŸæ¥çš„ `mr` è„šæœ¬ç¼–å†™æˆå‘½ä»¤è¡Œå·¥å…· `npm` åŒ…ï¼Œå®ç°ä¸€æ¬¡å®‰è£…å¤šå¤„ä½¿ç”¨ï¼›
- åªç”¨åœ¨å®‰è£… `mr` åŒ…æ—¶é…ç½®ä¸€æ¬¡ `GitLab Token`ï¼Œä¸”éƒ½å­˜å‚¨åœ¨ç”¨æˆ·æœ¬åœ°ï¼›
- æä¾›ä¸æœåŠ¡ç«¯äº¤äº’çš„å­å‘½ä»¤ï¼Œå¯ä»¥ç›´æ¥åœ¨å‰ç«¯ç»´æŠ¤æœåŠ¡ç«¯æ•°æ®ã€‚

## å‰ç«¯å®ç°

- å€ŸåŠ© `yargs` åº“æ¥ç¼–å†™å‘½ä»¤è¡Œå·¥å…·

- å°†é¡¹ç›®ç¼–å†™æˆ `npm` åŒ…ï¼Œå‘å¸ƒåœ¨å…¬å¸ç§æœ‰ä»“åº“ä¸Š

> [ğŸ”—mrå·¥å…·ä½¿ç”¨æ–‡æ¡£](https://fenxianglife.yuque.com/technical-team/front/qpy4io)

### yargs å‘½ä»¤è¡Œè§£æåº“
`yargs` æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°è§£æåº“ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿæ„å»ºä¸€ä¸ªå‘½ä»¤è¡Œç¨‹åºã€‚ç±»ä¼¼åŠŸèƒ½çš„åº“è¿˜æœ‰ `commander`ã€`meow`ã€‚

> [ğŸ”—å®˜æ–¹æ–‡æ¡£](http://yargs.js.org/docs/)

#### option é€‰é¡¹

#### command å­å‘½ä»¤


### npm å‘åŒ…

`npm` è§„å®šéœ€è¦å°†å¯æ‰§è¡Œçš„å‘½ä»¤æ”¾åœ¨ `bin` ç›®å½•ä¸‹ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ç›®å½•ç»“æ„ä¸ºï¼š

```sh
.
â”œâ”€â”€ bin
â”‚   â”œâ”€â”€ mr
â”‚   â”œâ”€â”€ create.js
â”‚   â””â”€â”€ ...
â”œâ”€â”€ utils
â””â”€â”€ package.json
```

è¿˜éœ€åœ¨ `package.json` ç¨ä½œé…ç½®ï¼š

```json
{
  ...
  "bin": {
    "mr": "bin/mr"
  },
  "files": [
    "bin",
    "utils"
  ],
  "publishConfig": {
    "registry": "http://nexus.fenxianglife.com/repository/npm-private"
  },
  ...
}

```

è¿è¡Œ `npm publish` å³å¯å°†å½“å‰ `bin`ã€`utils` ä¸­çš„æ–‡ä»¶æ‰“åŒ…ä¸Šä¼ è‡³ `npm` ä»“åº“

## æœåŠ¡ç«¯å®ç°

æœåŠ¡ç«¯æŒ‰ç…§ `egg` çš„è§„èŒƒå¯¹ä»£ç è¿›è¡Œäº†é‡æ„ï¼Œä½¿å…¶ä¾¿äºç»´æŠ¤ã€‚

`egg` åŸºç¡€åŠŸèƒ½:

- `Router` è·¯ç”±ã€‚æš´éœ²ç»™å‰ç«¯çš„æ¥å£ï¼ŒæŒ‡å‘å¯¹åº”çš„ `Controller`
- `Controller` æ§åˆ¶å™¨ã€‚è§£æå‰ç«¯çš„è¯·æ±‚ï¼Œå¤„ç†åè¿”å›ç›¸åº”çš„ç»“æœ
- `Service` æœåŠ¡ã€‚ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œä¾› `Controller` è°ƒç”¨
- `Middleware` ä¸­é—´ä»¶ã€‚ç±»ä¼¼äºæ‹¦æˆªå™¨

### token æ ¡éªŒä¸­é—´ä»¶

å°†å‰ç«¯ä¼ è¿‡æ¥çš„ `token` ä¼ ç»™ `GitLab`ï¼ŒéªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œæ ‡è¯† `token` æ˜¯å¦æœ‰æ•ˆã€‚

```js
async (ctx, next) => {
  await next();

  const { token } = ctx.header;
  !token && ctx.throw(422, 'æ—  token');

  const { status, data } = await ctx.curl('https://gitlab.fenxianglife.com/api/v4/user', {
    method: 'GET',
    data: { private_token: token },
  });
  status !== 200 && ctx.throw(422, 'token éªŒè¯å¤±è´¥');
};
```
